name: âš¡ Performance Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: âš¡ Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: crates

      - name: ðŸ—ï¸ Build Release
        run: cargo build --release -p neex-cli
        working-directory: crates

      - name: âš¡ Run Benchmarks
        run: |
          echo "## âš¡ Performance Benchmarks" > benchmark-results.md
          echo "" >> benchmark-results.md
          echo "| Scenario | Time | Status |" >> benchmark-results.md
          echo "|----------|------|--------|" >> benchmark-results.md
          
          # Cold build simulation
          start_time=$(date +%s%N)
          ./target/release/neex --version > /dev/null 2>&1
          end_time=$(date +%s%N)
          duration=$(( (end_time - start_time) / 1000000 ))
          echo "| Cold Start | ${duration}ms | âœ… |" >> benchmark-results.md
          
          echo "" >> benchmark-results.md
          echo "**Environment:** Ubuntu Latest, $(nproc) cores" >> benchmark-results.md
          echo "**Timestamp:** $(date -u)" >> benchmark-results.md
        working-directory: crates

      - name: ðŸ“Š Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('crates/benchmark-results.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: results
            });

      - name: ðŸ“ˆ Store Results
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          mkdir -p benchmarks
          cp crates/benchmark-results.md benchmarks/$(date +%Y-%m-%d).md
          git add benchmarks/
          git commit -m "ðŸ“ˆ Add benchmark results for $(date +%Y-%m-%d)" || exit 0
          git push